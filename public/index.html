<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 提示词收藏家 (NAS Docker版)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* 液态流体背景 */
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #f0f4f8;
            background-image: 
                radial-gradient(at 0% 0%, rgba(167, 139, 250, 0.15) 0px, transparent 50%), 
                radial-gradient(at 100% 0%, rgba(192, 132, 252, 0.15) 0px, transparent 50%), 
                radial-gradient(at 100% 100%, rgba(244, 114, 182, 0.15) 0px, transparent 50%), 
                radial-gradient(at 0% 100%, rgba(96, 165, 250, 0.15) 0px, transparent 50%);
            background-attachment: fixed;
            background-size: cover;
        }
        
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.3); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        
        /* 间距调整 */
        .waterfall-container { column-count: var(--col-count); column-gap: 0.75rem; }
        .grid-container { display: grid; grid-template-columns: repeat(var(--col-count), minmax(0, 1fr)); gap: 0.75rem; }
        .waterfall-item { break-inside: avoid; margin-bottom: 0.75rem; transform: translateZ(0); }
        
        .blur-effect { filter: blur(24px) saturate(180%) contrast(110%); pointer-events: none; transition: all 0.6s cubic-bezier(0.22, 1, 0.36, 1); transform: scale(1.08); opacity: 0.8; }
        
        /* 动画 */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .scale-enter-active, .scale-leave-active { transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .scale-enter-from, .scale-leave-to { opacity: 0; transform: scale(0.95); filter: blur(8px); }
        
        /* Toast */
        .toast-enter-active, .toast-leave-active { transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .toast-enter-from, .toast-leave-to { opacity: 0; transform: translateY(-20px) scale(0.9); }

        /* 玻璃拟态基础类 */
        .glass-panel {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(24px) saturate(180%);
            -webkit-backdrop-filter: blur(24px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.7);
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.08);
        }
        
        .glass-heavy {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(40px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.12);
        }

        .resize-handle { position: absolute; top: 0; bottom: 0; right: 0; width: 4px; cursor: col-resize; transition: background 0.2s; z-index: 50; }
        .resize-handle:hover, .resize-handle.resizing { background: #8b5cf6; }

        .empty-pattern {
            background-image: radial-gradient(rgba(203, 213, 225, 0.3) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .prompt-fullscreen {
            position: fixed;
            inset: 0;
            z-index: 120;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 3rem;
            display: flex;
            flex-direction: column;
        }

        /* 卡片视图 */
        .card-view-item {
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(16px);
            border-radius: 1.25rem;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02), 0 0 0 1px rgba(255, 255, 255, 0.6) inset;
            transition: all 0.4s cubic-bezier(0.22, 1, 0.36, 1);
            height: auto;
        }
        
        .card-view-item:hover {
            transform: translateY(-4px) scale(1.005);
            box-shadow: 0 20px 40px -4px rgba(0, 0, 0, 0.08), 0 0 0 1px rgba(255, 255, 255, 0.9) inset;
            background: rgba(255, 255, 255, 0.95);
            z-index: 10;
        }
        
        .card-view-media-area {
            width: 100%;
            aspect-ratio: 16/9;
            position: relative;
            flex-shrink: 0;
        }

        .card-view-info-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 1.25rem;
            position: relative;
        }
        
        /* 桌面端横向布局 */
        @media (min-width: 1024px) {
            .grid-container[style*="--col-count: 1"] .card-view-item,
            .grid-container[style*="--col-count: 2"] .card-view-item {
                flex-direction: row;
                height: 300px;
            }

            .grid-container[style*="--col-count: 1"] .card-view-media-area,
            .grid-container[style*="--col-count: 2"] .card-view-media-area {
                width: 42%;
                height: 100%;
                aspect-ratio: auto;
            }

            .grid-container[style*="--col-count: 1"] .card-view-info-area,
            .grid-container[style*="--col-count: 2"] .card-view-info-area {
                width: 58%;
                height: 100%;
                overflow: hidden;
            }
        }
    </style>
</head>
<body class="text-slate-800 h-screen flex overflow-hidden selection:bg-indigo-100 selection:text-indigo-700">

<div id="app" class="flex w-full h-full relative">

    <div class="fixed top-6 left-1/2 -translate-x-1/2 z-[200] flex flex-col gap-2 pointer-events-none">
        <transition-group name="toast">
            <div v-for="toast in toasts" :key="toast.id" class="pointer-events-auto glass-heavy rounded-full px-6 py-3 flex items-center gap-3 min-w-[280px] shadow-xl shadow-indigo-500/10">
                <i :class="getToastIcon(toast.type)" class="text-lg"></i>
                <span class="text-sm font-bold text-slate-700 tracking-wide">{{ toast.message }}</span>
            </div>
        </transition-group>
    </div>

    <input type="file" ref="fileInput" class="hidden" @change="handleFileUpload" accept="image/*,video/*" multiple>
    <input type="file" ref="importInput" class="hidden" @change="handleImportData" accept=".json">

    <aside class="glass-panel flex flex-col z-20 shadow-2xl shadow-indigo-500/5 flex-shrink-0 relative transition-all duration-300 ease-[cubic-bezier(0.22,1,0.36,1)] overflow-hidden"
           :style="{ width: isSidebarOpen ? sidebarWidth + 'px' : '0px', opacity: isSidebarOpen ? 1 : 0, transform: isSidebarOpen ? 'translateX(0)' : 'translateX(-20px)' }">
        <div class="resize-handle" @mousedown="startResize" :class="{ 'resizing': isResizing }"></div>
        <div class="flex flex-col h-full w-full">
            <div class="p-8 pb-4 flex items-center gap-4 select-none shrink-0">
                <div class="w-11 h-11 bg-gradient-to-br from-indigo-500 to-violet-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-indigo-500/30 shrink-0"><i class="fas fa-layer-group text-lg"></i></div>
                <div class="overflow-hidden whitespace-nowrap">
                    <h1 class="text-xl font-black tracking-tight text-slate-800">Prompt<span class="text-indigo-600">Hub</span></h1>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-[0.2em] mt-0.5">Asset Manager</p>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto px-6 py-4 space-y-6 custom-scrollbar">
                 <div class="bg-white/40 p-1 rounded-2xl border border-white/60 shadow-sm mb-4">
                    <button @click="toggleFavoritesFilter" class="w-full py-2.5 text-xs font-bold rounded-xl transition-all flex items-center justify-center gap-2 group" 
                            :class="showFavoritesOnly ? 'bg-red-50 text-red-500' : 'text-slate-500 hover:text-indigo-600 hover:bg-white'">
                        <i class="fas" :class="showFavoritesOnly ? 'fa-heart' : 'fa-heart'"></i> {{ showFavoritesOnly ? '查看全部' : '我的收藏' }}
                    </button>
                </div>

                <div class="bg-white/40 p-1 rounded-2xl border border-white/60 shadow-sm">
                    <button @click="resetAllFilters" class="w-full py-2.5 text-xs font-bold text-slate-500 hover:text-indigo-600 hover:bg-white rounded-xl transition-all flex items-center justify-center gap-2 group">
                        <i class="fas fa-undo-alt group-hover:-rotate-180 transition-transform duration-500"></i> 重置筛选
                    </button>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-3"><h3 class="text-[11px] font-extrabold text-slate-400 uppercase tracking-widest pl-1">Media Type</h3></div>
                    <div class="flex gap-2 p-1.5 bg-white/50 rounded-2xl border border-white/50 shadow-inner"><button v-for="item in filters.mediaType.options" :key="item" @click="toggleFilter('mediaType', item)" :class="filters.mediaType.selected.includes(item) ? 'bg-indigo-600 text-white shadow-md' : 'text-slate-500 hover:text-indigo-600 hover:bg-white/60'" class="flex-1 py-2.5 rounded-xl text-xs font-bold transition-all duration-300">{{ item }}</button></div>
                </div>

                <div class="h-px bg-gradient-to-r from-transparent via-indigo-100 to-transparent"></div>

                <div v-for="(group, key) in dynamicFilters" :key="key">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-[11px] font-extrabold text-slate-400 uppercase tracking-widest pl-1">{{ group.label }}</h3>
                        <transition name="fade"><button v-if="filterState[key].length" @click="filterState[key] = []" class="text-[10px] font-bold text-indigo-500 hover:text-indigo-700 bg-indigo-50 px-2 py-0.5 rounded-md">清除</button></transition>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button v-for="item in group.options" :key="item" @click="toggleFilter(key, item)" 
                                :class="filterState[key].includes(item) ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200 transform scale-105' : 'bg-white/60 text-slate-500 border border-white/60 hover:border-indigo-200 hover:text-indigo-600 hover:bg-white'" 
                                class="px-3.5 py-1.5 rounded-xl text-xs font-bold transition-all duration-200">{{ item }}</button>
                    </div>
                </div>
            </div>

            <div class="p-6 bg-white/30 border-t border-white/50 backdrop-blur-md shrink-0">
                <div class="grid grid-cols-4 gap-3">
                    <button @click="handleEyeClick" class="col-span-3 flex items-center justify-center space-x-2 py-3.5 rounded-2xl transition-all duration-300 shadow-sm group active:scale-95 overflow-hidden border border-white/50" :class="eyeButtonClass" :title="eyeButtonTitle"><i class="fas text-lg transition-transform duration-300 group-hover:scale-110 shrink-0" :class="eyeIconClass"></i><span class="text-xs font-bold tracking-wide">{{ eyeButtonText }}</span></button>
                    <button @click="openSettings" class="col-span-1 flex items-center justify-center bg-white/60 border border-white/50 text-slate-400 hover:text-indigo-600 hover:bg-white rounded-2xl transition-all shadow-sm hover:shadow-md active:scale-95"><i class="fas fa-cog text-xl"></i></button>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full overflow-hidden relative">
        <header class="pt-8 pb-4 px-10 flex items-center justify-between z-40 sticky top-0">
            <div class="absolute inset-x-6 top-4 bottom-0 bg-white/30 backdrop-blur-xl rounded-[2rem] border border-white/40 shadow-sm -z-10"></div>
            
            <div class="flex items-center space-x-6">
                <button @click="isSidebarOpen = !isSidebarOpen" class="w-10 h-10 rounded-xl flex items-center justify-center text-slate-500 hover:bg-white hover:text-indigo-600 transition-all"><i class="fas" :class="isSidebarOpen ? 'fa-outdent' : 'fa-indent'"></i></button>
                <div class="h-5 w-px bg-slate-400/20"></div>
                
                <div class="bg-slate-200/40 p-1 rounded-xl flex">
                    <button @click="switchViewMode('waterfall')" :class="viewMode==='waterfall'?'bg-white text-indigo-700 shadow-sm font-bold':'text-slate-500 hover:text-slate-700'" class="px-4 py-1.5 rounded-lg text-xs transition-all duration-200 flex items-center gap-2"><i class="fas fa-stream"></i> <span class="hidden md:inline">瀑布流</span></button>
                    <button @click="switchViewMode('card')" :class="viewMode==='card'?'bg-white text-indigo-700 shadow-sm font-bold':'text-slate-500 hover:text-slate-700'" class="px-4 py-1.5 rounded-lg text-xs transition-all duration-200 flex items-center gap-2"><i class="fas fa-th-large"></i> <span class="hidden md:inline">卡片</span></button>
                </div>
                
                <div class="flex items-center gap-3 group px-4 hidden lg:flex bg-slate-200/40 rounded-xl p-1.5">
                    <i class="fas fa-th text-slate-400 text-xs"></i>
                    <input type="range" v-model.number="sliderVal" min="1" max="6" step="1" 
                           class="w-24 h-1.5 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-indigo-500"
                           style="direction: rtl;"> 
                    <i class="fas fa-stop text-slate-400 text-xs"></i>
                </div>
            </div>

            <div class="flex items-center space-x-2 sm:space-x-4 flex-1 justify-end min-w-0">
                <div class="relative z-50 shrink-0">
                    <button @click="isSortMenuOpen = !isSortMenuOpen" class="flex items-center bg-white/50 hover:bg-white rounded-full pl-2 pr-4 py-1.5 shadow-sm border border-white/50 hover:border-indigo-200 transition-all group">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-slate-400 group-hover:text-indigo-600 bg-white group-hover:bg-indigo-50 transition-colors mr-2"><i class="fas" :class="sortConfig.order === 'asc' ? 'fa-sort-amount-down-alt' : 'fa-sort-amount-down'"></i></div>
                        <div class="flex flex-col items-start hidden xl:flex"><span class="text-[10px] text-slate-400 font-bold uppercase leading-none">Sort By</span><span class="text-xs font-bold text-slate-700 leading-tight">{{ getSortLabel(sortConfig.key) }}</span></div>
                    </button>
                    <transition name="popover"><div v-if="isSortMenuOpen" class="absolute top-full right-0 mt-3 w-52 glass-panel rounded-2xl shadow-2xl p-2 z-50 origin-top-right" @click.self="isSortMenuOpen = false"><div class="text-[10px] font-bold text-slate-400 px-4 py-2 uppercase tracking-wider">排序依据</div><button v-for="opt in sortOptions" :key="opt.value" @click="selectSort(opt.value)" class="w-full text-left px-4 py-2.5 rounded-xl text-sm font-bold flex items-center justify-between transition-colors mb-1" :class="sortConfig.key === opt.value ? 'bg-indigo-50 text-indigo-700' : 'text-slate-600 hover:bg-white/50'">{{ opt.label }}<i v-if="sortConfig.key === opt.value" class="fas fa-check text-indigo-600 text-xs"></i></button><div class="h-px bg-slate-200/50 my-1"></div><button @click="toggleSortOrder" class="w-full text-left px-4 py-2.5 rounded-xl text-sm font-medium text-slate-600 hover:bg-white/50 flex items-center gap-2 transition-colors"><i class="fas" :class="sortConfig.order === 'asc' ? 'fa-arrow-up' : 'fa-arrow-down'"></i>{{ sortConfig.order === 'asc' ? '升序 (Low to High)' : '降序 (High to Low)' }}</button></div></transition>
                    <div v-if="isSortMenuOpen" class="fixed inset-0 z-40" @click="isSortMenuOpen = false"></div>
                </div>
                
                <div class="relative group hidden sm:block flex-1 max-w-xs min-w-0">
                    <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-500 transition-colors text-xs"></i>
                    <input v-model="searchQuery" type="text" placeholder="Search..." class="pl-10 pr-4 py-3 bg-white/50 hover:bg-white rounded-full text-sm shadow-sm border border-white/50 focus:border-indigo-300 focus:ring-4 focus:ring-indigo-500/10 focus:outline-none w-full transition-all">
                </div>
                
                <button @click="createNew" class="shrink-0 bg-indigo-600 hover:bg-indigo-700 text-white px-4 md:px-6 py-3 rounded-full text-sm font-bold shadow-lg shadow-indigo-500/30 hover:shadow-indigo-500/50 flex items-center gap-2 hover:-translate-y-0.5 active:translate-y-0 transition-all">
                    <i class="fas fa-plus"></i><span class="hidden md:inline">New</span>
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-10 scroll-smooth">
            <div :class="viewMode === 'waterfall' ? 'waterfall-container' : 'grid-container'" 
                 :style="{ '--col-count': sliderVal }">
                
                <div v-for="item in filteredList" :key="item.id" 
                    @click="handleCardClick(item)"
                    :class="['group relative break-inside-avoid overflow-hidden transition-all duration-500', 
                        viewMode === 'waterfall' ? 'waterfall-item rounded-2xl bg-white/80 backdrop-blur-md shadow-sm border border-white/50 hover:shadow-xl hover:-translate-y-1' : 'card-view-item',
                    ]">
                    
                    <div class="relative cursor-pointer overflow-hidden bg-slate-200/50 group/media" 
                         :class="[
                            viewMode === 'card' ? 'card-view-media-area' : 'w-full',
                            {'blur-effect': shouldBlur(item)}
                         ]"
                         @mouseenter="item.showPlayBtn = true"
                         @mouseleave="stopVideo(item)">
                        
                        <div class="absolute top-3 left-3 right-3 z-30 flex justify-between items-start pointer-events-none">
                            <div class="flex gap-2">
                                <span class="text-[9px] px-2 py-1 rounded-md font-extrabold uppercase backdrop-blur-md shadow-sm border border-white/20 text-slate-700 tracking-wide bg-white/80">
                                     {{ getCategoryLabel(item) }}
                                </span>
                                <span v-if="isItemPrivate(item)" class="w-6 h-6 rounded-md bg-rose-500/90 text-white flex items-center justify-center shadow-md backdrop-blur-md"><i class="fas fa-lock text-[10px]"></i></span>
                                <span v-if="shouldBlur(item)" class="w-6 h-6 rounded-md bg-slate-800/80 text-white flex items-center justify-center shadow-md backdrop-blur-md"><i class="fas fa-eye-slash text-[10px]"></i></span>
                            </div>
                            <button @click.stop="toggleFavorite(item)" class="w-8 h-8 rounded-full bg-white/80 backdrop-blur-md flex items-center justify-center shadow-sm hover:bg-white hover:scale-110 transition-all pointer-events-auto group/fav">
                                <i class="fas fa-heart text-sm transition-colors" :class="item.isFavorite ? 'text-red-500' : 'text-slate-300 group-hover/fav:text-red-300'"></i>
                            </button>
                        </div>

                        <div v-if="shouldBlur(item)" class="absolute inset-0 z-40 backdrop-blur-xl bg-white/50 flex flex-col items-center justify-center gap-3 transition-all duration-300 group-hover:backdrop-blur-2xl">
                            <div class="w-12 h-12 bg-white rounded-full shadow-lg flex items-center justify-center text-slate-400 group-hover:text-indigo-500 group-hover:scale-110 transition-all">
                                <i class="fas fa-lock text-lg"></i>
                            </div>
                            <span class="text-xs font-bold text-slate-500 uppercase tracking-widest group-hover:text-indigo-600 transition-colors">Private Content</span>
                        </div>
                        
                        <div v-if="isTextCard(item)" class="p-8 text-sm leading-loose opacity-90 font-serif h-full w-full flex flex-col justify-center text-center text-slate-700 bg-gradient-to-br from-amber-50 to-orange-50" 
                             :class="[item.category === 't2t' ? 'card-t2t' : '']">
                            <div v-if="item.resultText" class="line-clamp-6">{{ item.resultText }}</div>
                            <div v-else class="text-slate-400 opacity-50 py-4 empty-pattern w-full flex flex-col items-center"><i class="fas fa-align-left text-2xl mb-2"></i><span class="text-xs font-bold uppercase tracking-wider">暂无文案</span></div>
                        </div>
                        
                        <div v-else class="w-full h-full relative">
                             <template v-if="item.mediaList && item.mediaList.length > 0">
                                <template v-if="viewMode === 'waterfall'">
                                    <video v-if="isVideo(item.mediaList[0])" :src="item.mediaList[0]" class="w-full h-auto invisible relative z-0 block min-h-[200px]" preload="metadata"></video>
                                    <img v-else :src="item.mediaList[0]" class="w-full h-auto invisible relative z-0 block">
                                    <div class="absolute inset-0 z-10 w-full h-full">
                                        <video v-if="isVideo(item.mediaList[item.activeImgIdx || 0])" :src="item.mediaList[item.activeImgIdx || 0]" :ref="el => setVideoRef(el, item.id)" class="w-full h-full object-cover block" loop muted playsinline></video>
                                        <img v-else :src="item.mediaList[item.activeImgIdx || 0]" class="w-full h-full object-cover block">
                                    </div>
                                </template>
                                <template v-else>
                                    <video v-if="isVideo(item.mediaList[item.activeImgIdx || 0])" :src="item.mediaList[item.activeImgIdx || 0]" :ref="el => setVideoRef(el, item.id)" class="w-full h-full object-cover block" loop muted playsinline></video>
                                    <img v-else :src="item.mediaList[item.activeImgIdx || 0]" class="w-full h-full object-cover block">
                                </template>

                                <div v-if="isVideo(item.mediaList[item.activeImgIdx || 0]) && !item.isPlaying" 
                                     @click.stop="playVideo(item)"
                                     class="absolute inset-0 z-20 flex items-center justify-center bg-black/10 backdrop-blur-[2px] transition-all duration-300"
                                     :class="item.showPlayBtn ? 'opacity-100' : 'opacity-0'">
                                    <div class="w-14 h-14 rounded-full bg-white/20 backdrop-blur-md border border-white/50 text-white flex items-center justify-center shadow-2xl hover:scale-110 transition-transform hover:bg-white hover:text-indigo-600">
                                        <i class="fas fa-play ml-1 text-xl"></i>
                                    </div>
                                </div>
                            </template>
                            <div v-else class="absolute inset-0 flex flex-col items-center justify-center text-slate-400 empty-pattern">
                                <i class="fas fa-image text-3xl mb-2 opacity-30"></i>
                                <span class="text-[10px] font-bold uppercase tracking-widest opacity-50">No Media</span>
                            </div>

                             <div v-if="item.mediaList && item.mediaList.length > 1 && !item.isPlaying" class="absolute inset-0 flex justify-between items-center px-3 opacity-0 group-hover/media:opacity-100 transition-opacity z-30 pointer-events-none">
                                <button @click.stop="prevCardImage(item)" class="pointer-events-auto w-8 h-8 rounded-full bg-black/40 hover:bg-white hover:text-indigo-600 text-white backdrop-blur-md flex items-center justify-center shadow-lg transition-all active:scale-95"><i class="fas fa-chevron-left text-[10px]"></i></button>
                                <button @click.stop="nextCardImage(item)" class="pointer-events-auto w-8 h-8 rounded-full bg-black/40 hover:bg-white hover:text-indigo-600 text-white backdrop-blur-md flex items-center justify-center shadow-lg transition-all active:scale-95"><i class="fas fa-chevron-right text-[10px]"></i></button>
                            </div>
                            <div v-if="item.mediaList && item.mediaList.length > 1 && !item.isPlaying" class="absolute bottom-3 right-3 bg-black/60 text-white text-[9px] font-bold px-2 py-1 rounded-lg backdrop-blur-md border border-white/10 z-30">{{ (item.activeImgIdx || 0) + 1 }}/{{ item.mediaList.length }}</div>
                        </div>

                        <div v-if="viewMode === 'waterfall' && !item.isPlaying" class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col justify-end p-5 z-20 pointer-events-none">
                            <div class="flex justify-end gap-2 transform translate-y-4 group-hover:translate-y-0 transition-transform duration-300 pointer-events-auto mb-2">
                                <button @click.stop="quickEdit(item)" class="w-9 h-9 rounded-full bg-white/10 hover:bg-white hover:text-indigo-600 text-white backdrop-blur-md flex items-center justify-center transition-all border border-white/20" title="编辑"><i class="fas fa-edit text-sm"></i></button>
                                <button @click.stop="copyText(item.prompt)" class="w-9 h-9 rounded-full bg-white/10 hover:bg-white hover:text-indigo-600 text-white backdrop-blur-md flex items-center justify-center transition-all border border-white/20" title="复制"><i class="far fa-copy text-sm"></i></button>
                                <button @click.stop="duplicatePrompt(item)" class="w-9 h-9 rounded-full bg-white/10 hover:bg-white hover:text-green-600 text-white backdrop-blur-md flex items-center justify-center transition-all border border-white/20" title="副本"><i class="far fa-clone text-sm"></i></button>
                                <button @click.stop="deleteItem(item)" class="w-9 h-9 rounded-full bg-white/10 hover:bg-red-500 text-white backdrop-blur-md flex items-center justify-center transition-all border border-white/20" title="删除"><i class="fas fa-trash text-sm"></i></button>
                            </div>
                            <div class="transform translate-y-2 group-hover:translate-y-0 transition-transform duration-300">
                                <h3 class="text-white font-bold text-base line-clamp-2 drop-shadow-md mb-2">{{ item.title }}</h3>
                                <div class="flex flex-wrap gap-1.5">
                                    <span v-for="t in (item.tags || []).slice(0,3)" class="text-[10px] bg-white/20 backdrop-blur-md text-white px-2 py-0.5 rounded-md border border-white/10">{{ t }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="viewMode === 'card'" class="p-5 flex flex-col h-full relative card-view-info-area" @click="handleCardClick(item)">
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="font-extrabold text-slate-800 text-lg leading-snug line-clamp-2 pr-4 tracking-tight" :title="item.title">{{ item.title }}</h3>
                            <div class="flex flex-col items-end shrink-0">
                                <span class="text-[10px] font-bold text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded">{{ formatDate(item.updatedTime).split(' ')[0] }}</span>
                            </div>
                        </div>

                        <div class="mb-4 flex-1 min-h-0 relative group/prompt">
                            <div class="text-xs font-mono text-slate-600 leading-relaxed bg-slate-50/80 p-3.5 rounded-xl border border-slate-200/60 h-full overflow-y-auto custom-scrollbar select-text hover:bg-white hover:border-indigo-200 transition-all cursor-pointer shadow-inner" 
                                 title="点击预览" @click.stop="openDetail(item)">
                                {{ item.prompt || '暂无提示词内容...' }}
                            </div>
                        </div>

                        <div class="mt-auto">
                            <div class="flex flex-wrap gap-1.5 mb-4 min-h-[1.5rem]" v-if="(item.tags && item.tags.length) || (item.tools && item.tools.length) || (item.models && item.models.length)">
                                <span v-for="t in (item.tools || [])" class="px-2 py-0.5 rounded-md text-[10px] font-bold bg-indigo-50 text-indigo-600 border border-indigo-100 flex items-center gap-1"><i class="fas fa-wrench text-[8px] opacity-70"></i>{{t}}</span>
                                <span v-for="m in (item.models || [])" class="px-2 py-0.5 rounded-md text-[10px] font-bold bg-fuchsia-50 text-fuchsia-600 border border-fuchsia-100 flex items-center gap-1"><i class="fas fa-cube text-[8px] opacity-70"></i>{{m}}</span>
                                <span v-for="t in (item.tags || []).slice(0,4)" class="px-2 py-0.5 rounded-md text-[10px] font-medium bg-slate-100 text-slate-500 border border-slate-200">#{{ t }}</span>
                                <span v-if="(item.tags || []).length > 4" class="px-1.5 py-0.5 rounded-md text-[10px] text-slate-400 bg-slate-50 border border-slate-100">+{{ item.tags.length-4 }}</span>
                            </div>

                            <div class="absolute bottom-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition-all duration-300 transform translate-y-2 group-hover:translate-y-0">
                                <div class="glass-heavy p-1 rounded-xl shadow-xl flex gap-1 border border-white/50">
                                    <button @click.stop="quickEdit(item)" class="w-8 h-8 flex items-center justify-center rounded-lg text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 transition-all" title="编辑">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button @click.stop="copyText(item.prompt)" class="w-8 h-8 flex items-center justify-center rounded-lg text-slate-400 hover:text-blue-600 hover:bg-blue-50 transition-all" title="复制">
                                        <i class="far fa-copy"></i>
                                    </button>
                                    <button @click.stop="duplicatePrompt(item)" class="w-8 h-8 flex items-center justify-center rounded-lg text-slate-400 hover:text-emerald-600 hover:bg-emerald-50 transition-all" title="副本">
                                        <i class="far fa-clone"></i>
                                    </button>
                                    <div class="w-px h-4 bg-slate-200 self-center mx-1"></div>
                                    <button @click.stop="deleteItem(item)" class="w-8 h-8 flex items-center justify-center rounded-lg text-slate-400 hover:text-rose-500 hover:bg-rose-50 transition-all" title="删除">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            <div v-if="filteredList.length === 0" class="h-full flex flex-col items-center justify-center text-slate-300 pb-20"><i class="fas fa-box-open text-7xl mb-6 opacity-20"></i><p class="font-bold text-lg text-slate-400 mt-4">还没有内容</p><button @click="createNew" class="mt-6 text-indigo-500 hover:text-indigo-600 bg-indigo-50 hover:bg-indigo-100 px-6 py-2 rounded-full font-bold transition-all">创建新创意</button></div>
        </div>
    </main>

    <transition name="scale">
        <div v-if="modals.detail || modals.history" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/40 backdrop-blur-md p-4 sm:p-8" @click.self="modals.detail = false; modals.history = false">
            <div class="w-full max-w-[90rem] h-[85vh] max-h-[900px] glass-panel rounded-[2.5rem] shadow-2xl shadow-indigo-900/20 flex flex-col md:flex-row overflow-hidden relative transition-all duration-500 ease-in-out">
                
                <div v-if="modals.history" class="w-72 bg-slate-50/80 border-r border-white/50 flex flex-col shrink-0 backdrop-blur-sm">
                    <div class="p-6 border-b border-white/50 flex justify-between items-center">
                        <h3 class="font-bold text-slate-700 text-lg">版本历史</h3>
                        <button @click="modals.history = false; modals.detail = true" class="text-xs font-bold text-slate-400 hover:text-indigo-600 flex items-center gap-1 transition-colors"><i class="fas fa-arrow-left"></i> 返回</button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
                        <div v-for="(log, idx) in (currentItem.history || []).slice().reverse()" :key="idx" 
                             @click="viewHistoryItem(log)"
                             class="p-4 rounded-2xl cursor-pointer border transition-all"
                             :class="selectedHistoryLog === log ? 'bg-white border-indigo-400 shadow-md ring-2 ring-indigo-100' : 'bg-white/50 border-transparent hover:bg-white hover:shadow-sm'">
                            <div class="text-xs font-bold text-slate-700 mb-1 flex items-center gap-2"><i class="far fa-clock text-indigo-400"></i> {{ formatDate(log.time) }}</div>
                            <div class="text-[11px] text-slate-500 flex justify-between items-center mt-2">
                                <span class="bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded-md font-bold">{{ log.action }}</span>
                                <span class="font-mono text-[10px] opacity-60">User</span>
                            </div>
                        </div>
                        <div v-if="!(currentItem.history || []).length" class="text-center text-xs text-slate-400 py-10 flex flex-col items-center gap-2"><i class="fas fa-history text-2xl opacity-30"></i><span>暂无历史记录</span></div>
                    </div>
                </div>

                <div class="relative flex flex-col overflow-hidden transition-all duration-500 bg-slate-100 shrink-0 md:h-full" :class="[isEditing && !modals.history ? 'md:w-[35%]' : (modals.history ? 'flex-1' : 'md:w-[60%]'), 'h-1/3 md:h-full']">
                     <template v-for="displayItem in [modals.history && selectedHistoryLog ? selectedHistoryLog.snapshot : currentItem]" :key="displayItem.id">
                        <div v-if="(isEditing && !modals.history && editingCategory === '文字') || (!isEditing && (displayItem.categories||[]).includes('t2t')) || (modals.history && (displayItem.categories||[]).includes('t2t'))" class="absolute inset-0 bg-[#fffbeb] z-10 pattern-dots"></div>
                        <div v-else-if="displayItem.mediaList && displayItem.mediaList.length > 0 && !isVideo(displayItem.mediaList[activeMediaIndex])" class="ambient-bg transition-all duration-1000 transform scale-110 blur-3xl opacity-40" :style="{ backgroundImage: `url(${displayItem.mediaList[activeMediaIndex]})` }"></div>
                        
                        <div class="flex-1 overflow-hidden relative z-20 flex flex-col justify-center">
                            <div v-if="(isEditing && !modals.history && editingCategory === '文字') || (!isEditing && (displayItem.categories||[]).includes('t2t')) || (modals.history && (displayItem.categories||[]).includes('t2t'))" class="h-full p-10 md:p-16 flex flex-col items-center justify-center relative">
                                <i class="fas fa-quote-left text-5xl text-amber-900/10 absolute top-10 left-10"></i>
                                <div v-if="!isEditing || modals.history" class="text-xl md:text-2xl font-serif leading-loose text-amber-900/80 whitespace-pre-wrap selection:bg-amber-200 w-full h-full overflow-y-auto custom-scrollbar">{{ displayItem.resultText || "暂无文案内容..." }}</div>
                                <textarea v-else v-model="currentItem.resultText" class="w-full h-full bg-transparent outline-none resize-none text-xl md:text-2xl font-serif leading-loose text-amber-900/80 placeholder-amber-900/20 z-30" placeholder="在此输入生成后的文案内容..."></textarea>
                                <i class="fas fa-quote-right text-5xl text-amber-900/10 absolute bottom-10 right-10"></i>
                            </div>

                            <div v-else class="h-full flex flex-col relative w-full items-center justify-center p-4">
                                <div class="w-full h-full flex items-center justify-center overflow-hidden relative rounded-2xl shadow-2xl shadow-indigo-900/10 bg-black/5 backdrop-blur-sm border border-white/20">
                                    <template v-if="displayItem.mediaList && displayItem.mediaList.length > 0">
                                        <video v-if="isVideo(displayItem.mediaList[activeMediaIndex])" :src="displayItem.mediaList[activeMediaIndex]" class="max-w-full max-h-full object-contain z-10" controls autoplay loop playsinline></video>
                                        <img v-else :src="displayItem.mediaList[activeMediaIndex]" class="max-w-full max-h-full object-contain z-10">
                                        
                                        <div v-if="isEditing && !modals.history" class="absolute top-4 right-4 z-20 flex gap-2"><button @click="removeCurrentMedia" class="bg-white/20 hover:bg-red-500 text-white w-10 h-10 rounded-full flex items-center justify-center backdrop-blur-md transition-all shadow-lg"><i class="fas fa-trash"></i></button></div>
                                        <div v-if="displayItem.mediaList.length > 1" class="absolute inset-x-0 top-1/2 -translate-y-1/2 flex justify-between px-4 z-20 pointer-events-none">
                                            <button @click="prevMedia" class="pointer-events-auto bg-black/20 hover:bg-white hover:text-indigo-600 text-white w-12 h-12 rounded-full flex items-center justify-center backdrop-blur-md transition-all"><i class="fas fa-chevron-left"></i></button>
                                            <button @click="nextMedia" class="pointer-events-auto bg-black/20 hover:bg-white hover:text-indigo-600 text-white w-12 h-12 rounded-full flex items-center justify-center backdrop-blur-md transition-all"><i class="fas fa-chevron-right"></i></button>
                                        </div>
                                    </template>
                                    <div v-else class="text-slate-400 flex flex-col items-center z-10 opacity-60">
                                        <div v-if="isEditing && !modals.history" class="w-64 h-48 rounded-3xl border-2 border-dashed border-slate-300 flex flex-col items-center justify-center hover:border-indigo-400 hover:bg-indigo-50/50 transition-all cursor-pointer" @click="modals.upload = true">
                                            <i class="fas fa-cloud-upload-alt text-4xl mb-4 text-slate-300"></i>
                                            <span class="text-xs font-bold uppercase tracking-widest text-slate-400">Upload Media</span>
                                        </div>
                                        <div v-else class="flex flex-col items-center"><i class="fas fa-image text-6xl mb-4 opacity-50"></i><span class="font-bold text-xl">NO MEDIA</span></div>
                                    </div>
                                </div>
                                
                                <div v-if="(displayItem.mediaList && displayItem.mediaList.length > 1) || (isEditing && !modals.history)" class="h-20 mt-4 flex items-center gap-3 overflow-x-auto custom-scrollbar shrink-0 z-20 w-full justify-center">
                                    <div v-if="isEditing && !modals.history" @click="modals.upload = true" class="h-16 w-16 shrink-0 rounded-lg border-2 border-dashed border-slate-300 flex items-center justify-center text-slate-400 hover:text-indigo-600 hover:border-indigo-400 hover:bg-indigo-50 cursor-pointer transition-all bg-white/50 flex-shrink-0"><i class="fas fa-plus text-xl"></i></div>
                                    <div v-for="(url, idx) in displayItem.mediaList" :key="idx" @click="activeMediaIndex = idx" class="h-16 w-24 shrink-0 rounded-lg overflow-hidden cursor-pointer border-2 transition-all opacity-60 hover:opacity-100 shadow-md flex-shrink-0" :class="activeMediaIndex === idx ? 'border-indigo-500 opacity-100 scale-105' : 'border-transparent bg-slate-200'">
                                        <video v-if="isVideo(url)" :src="url" class="w-full h-full object-cover"></video>
                                        <img v-else :src="url" class="w-full h-full object-cover">
                                    </div>
                                </div>
                            </div>
                        </div>
                     </template>
                </div>

                <div class="h-full bg-white/80 backdrop-blur-lg flex flex-col border-l border-white/50 relative z-20 transition-all duration-500 md:flex-1 w-full md:w-auto overflow-hidden">
                     <template v-for="displayItem in [modals.history && selectedHistoryLog ? selectedHistoryLog.snapshot : currentItem]" :key="displayItem.id">
                        
                        <div class="h-24 border-b border-slate-100 flex items-center justify-between px-8 bg-white/50 backdrop-blur shrink-0 z-10">
                            <div class="flex-1 mr-6 overflow-hidden">
                                <input v-if="isEditing && !modals.history" v-model="currentItem.title" class="text-2xl font-black w-full outline-none bg-transparent placeholder-slate-300 text-slate-800" placeholder="输入创意标题...">
                                <h1 v-else class="text-2xl font-black text-slate-800 truncate">{{ displayItem.title }} <span v-if="modals.history" class="text-xs text-white font-bold ml-2 bg-indigo-500 px-2 py-1 rounded-lg align-middle">v.History</span></h1>
                            </div>
                            <div class="flex items-center gap-3 shrink-0">
                                <template v-if="modals.history">
                                    <button @click="restoreVersion(selectedHistoryLog)" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-lg shadow-indigo-200 transition-all flex items-center gap-2"><i class="fas fa-undo"></i> 恢复此版本</button>
                                </template>
                                <template v-else>
                                    <template v-if="!isEditing">
                                        <button v-if="!isCreating" @click="modals.history = true; activeMediaIndex = 0; selectedHistoryLog = (currentItem.history||[])[(currentItem.history||[]).length-1]" class="text-slate-400 hover:text-indigo-600 px-3 py-2 rounded-xl hover:bg-indigo-50 transition-all text-xs font-bold flex items-center gap-2"><i class="fas fa-history"></i> <span class="hidden md:inline">历史</span></button>
                                        <div class="h-8 w-px bg-slate-200 mx-1"></div>
                                        <button @click="startEdit" class="text-indigo-600 bg-indigo-50 hover:bg-indigo-100 border border-indigo-100 px-5 py-2.5 rounded-xl text-sm font-bold transition-all shadow-sm"><i class="fas fa-pen mr-2"></i> 编辑</button>
                                        <button @click="modals.detail = false" class="text-slate-400 hover:bg-slate-100 w-10 h-10 rounded-full flex items-center justify-center transition-all"><i class="fas fa-times text-lg"></i></button>
                                    </template>
                                    <template v-else>
                                        <button @click="cancelEdit" class="text-slate-500 hover:bg-slate-100 px-5 py-2.5 rounded-xl text-sm font-bold transition-all">取消</button>
                                        <button @click="saveItem" class="bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500 text-white px-6 py-2.5 rounded-xl text-sm font-bold shadow-lg shadow-indigo-300 hover:shadow-xl transition-all"><i class="fas fa-save mr-2"></i> 保存</button>
                                    </template>
                                </template>
                            </div>
                            <button @click="toggleFavorite(currentItem)" class="w-10 h-10 rounded-full bg-white/50 hover:bg-white flex items-center justify-center transition-all ml-2" :title="currentItem.isFavorite ? '取消收藏' : '收藏'">
                                <i class="fas fa-heart text-lg" :class="currentItem.isFavorite ? 'text-red-500' : 'text-slate-300 hover:text-red-300'"></i>
                            </button>
                        </div>
                        
                        <div class="flex-1 overflow-y-auto overflow-x-hidden flex flex-col custom-scrollbar relative p-8">
                             <div v-if="isEditing && !modals.history" class="mb-8">
                                <div class="flex bg-white/60 p-1.5 rounded-2xl border border-slate-200 shadow-sm w-max mb-6">
                                    <button v-for="type in ['文字', '图片', '视频']" :key="type" 
                                            @click="isCreating ? editingCategory = type : null"
                                            class="px-5 py-2 rounded-xl text-xs font-bold transition-all"
                                            :class="[
                                                editingCategory === type ? 'bg-indigo-600 text-white shadow-md' : 'text-slate-500 hover:text-indigo-600',
                                                !isCreating ? 'cursor-not-allowed opacity-80' : 'cursor-pointer'
                                            ]">
                                        {{ type }}
                                    </button>
                                </div>
                                <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                                     <div>
                                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 block pl-1">Tools</label>
                                        <div class="flex flex-wrap gap-2 mb-2 p-2 bg-white/50 rounded-xl border border-slate-100 min-h-[46px]">
                                            <span v-for="(t,i) in (currentItem.tools || [])" :key="i" class="px-2 py-1 bg-white border border-slate-200 rounded-lg text-xs font-bold flex items-center gap-1 shadow-sm">{{t}}<button @click="currentItem.tools.splice(i,1)" class="text-slate-400 hover:text-red-500 ml-1">×</button></span>
                                            <input v-model="newToolInput" @keyup.enter="addRecTool(newToolInput)" placeholder="+Tool" class="bg-transparent text-xs outline-none w-20 px-2">
                                        </div>
                                        <div class="mt-2 flex flex-wrap gap-1.5" v-if="allTools.length">
                                            <button v-for="t in allTools" :key="t" 
                                                v-show="!(currentItem.tools || []).includes(t)"
                                                @click="addRecTool(t)"
                                                class="px-2 py-1 rounded-md text-[10px] font-bold bg-slate-100 text-slate-500 hover:bg-indigo-100 hover:text-indigo-600 transition-colors border border-transparent hover:border-indigo-200">
                                                + {{ t }}
                                            </button>
                                        </div>
                                     </div>
                                     <div>
                                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 block pl-1">Models</label>
                                        <div class="flex flex-wrap gap-2 mb-2 p-2 bg-white/50 rounded-xl border border-slate-100 min-h-[46px]">
                                            <span v-for="(m,i) in (currentItem.models || [])" :key="i" class="px-2 py-1 bg-white border border-slate-200 rounded-lg text-xs font-bold flex items-center gap-1 shadow-sm">{{m}}<button @click="currentItem.models.splice(i,1)" class="text-slate-400 hover:text-red-500 ml-1">×</button></span>
                                            <input v-model="newModelInput" @keyup.enter="addRecModel(newModelInput)" placeholder="+Model" class="bg-transparent text-xs outline-none w-20 px-2">
                                        </div>
                                        <div class="mt-2 flex flex-wrap gap-1.5" v-if="allModels.length">
                                            <button v-for="m in allModels" :key="m" 
                                                v-show="!(currentItem.models || []).includes(m)"
                                                @click="addRecModel(m)"
                                                class="px-2 py-1 rounded-md text-[10px] font-bold bg-slate-100 text-slate-500 hover:bg-fuchsia-100 hover:text-fuchsia-600 transition-colors border border-transparent hover:border-fuchsia-200">
                                                + {{ m }}
                                            </button>
                                        </div>
                                     </div>
                                </div>
                             </div>

                             <div v-else class="grid grid-cols-2 gap-4 mb-8">
                                <div class="bg-white/50 p-4 rounded-2xl border border-slate-100">
                                    <div class="text-[10px] text-slate-400 font-bold uppercase mb-1">Tools</div>
                                    <div class="flex flex-wrap gap-2"><span v-for="t in (displayItem.tools || [])" class="text-xs font-bold text-slate-700 bg-white px-2 py-1 rounded-md border border-slate-200 shadow-sm">{{t}}</span><span v-if="!(displayItem.tools || []).length" class="text-xs text-slate-400">-</span></div>
                                </div>
                                <div class="bg-white/50 p-4 rounded-2xl border border-slate-100">
                                    <div class="text-[10px] text-slate-400 font-bold uppercase mb-1">Models</div>
                                    <div class="flex flex-wrap gap-2"><span v-for="m in (displayItem.models || [])" class="text-xs font-bold text-slate-700 bg-white px-2 py-1 rounded-md border border-slate-200 shadow-sm">{{m}}</span><span v-if="!(displayItem.models || []).length" class="text-xs text-slate-400">-</span></div>
                                </div>
                             </div>

                             <div class="flex-1 flex flex-col min-h-[300px] mb-8">
                                <div class="flex justify-between items-center mb-3">
                                    <label class="text-xs font-bold text-indigo-500 uppercase tracking-wider flex items-center gap-2 pl-1"><i class="fas fa-magic"></i> Prompt 提示词</label>
                                    <div class="flex gap-2">
                                        <button v-if="isEditing && !modals.history" @click="isPromptExpanded = true" class="text-[10px] bg-white border border-slate-200 hover:border-indigo-300 text-slate-500 hover:text-indigo-600 px-3 py-1.5 rounded-lg font-bold transition-all shadow-sm"><i class="fas fa-expand-arrows-alt mr-1"></i> 全屏</button>
                                        <button v-if="!isEditing || modals.history" @click="copyText(displayItem.prompt)" class="text-[10px] bg-indigo-50 hover:bg-indigo-100 text-indigo-600 px-3 py-1.5 rounded-lg font-bold transition-all"><i class="far fa-copy mr-1"></i> 复制</button>
                                    </div>
                                </div>
                                <div class="flex-1 bg-white/60 rounded-3xl border border-slate-200 overflow-hidden relative focus-within:ring-4 focus-within:ring-indigo-500/10 focus-within:border-indigo-400 transition-all shadow-inner">
                                    <textarea v-if="isEditing && !modals.history" v-model="currentItem.prompt" class="w-full h-full p-6 bg-transparent text-base font-mono text-slate-700 outline-none resize-none leading-relaxed placeholder-slate-300 min-h-[200px]" placeholder="在此处输入详细的提示词..."></textarea>
                                    <div v-else class="w-full h-full p-6 overflow-y-auto text-sm font-mono text-slate-600 leading-relaxed whitespace-pre-wrap select-text custom-scrollbar">{{ displayItem.prompt || "无提示词内容" }}</div>
                                </div>
                             </div>

                             <div class="mb-4">
                                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 block pl-1">Tags</label>
                                <div class="flex flex-wrap gap-2">
                                    <span v-for="(tag, idx) in (displayItem.tags || [])" :key="idx" class="px-3 py-1.5 rounded-xl text-xs font-bold border flex items-center gap-2 transition-all shadow-sm" :class="(isEditing && !modals.history) ? 'bg-white border-indigo-200 text-indigo-600' : getTagStyle(tag)">#{{ tag }}<button v-if="isEditing && !modals.history" @click="currentItem.tags.splice(idx,1)" class="text-indigo-300 hover:text-red-500"><i class="fas fa-times"></i></button></span>
                                    <input v-if="isEditing && !modals.history" placeholder="+Tag" class="px-3 py-1.5 bg-white/50 rounded-xl outline-none text-xs w-20 border border-transparent focus:bg-white focus:border-indigo-400 focus:w-24 transition-all font-medium placeholder-slate-400" @keyup.enter="e=>{if(!currentItem.tags)currentItem.tags=[];currentItem.tags.push(e.target.value);e.target.value=''}">
                                </div>
                                <div class="mt-3 mb-1" v-if="isEditing && !modals.history && allTags.length">
                                    <div class="text-[9px] font-bold text-slate-300 uppercase tracking-wider mb-1">快速添加：</div>
                                    <div class="flex flex-wrap gap-1.5 max-h-24 overflow-y-auto custom-scrollbar">
                                        <button v-for="tag in allTags" :key="tag" 
                                            v-show="!(currentItem.tags || []).includes(tag)"
                                            @click="addRecTag(tag)"
                                            class="px-2 py-1 rounded-lg text-[10px] font-medium border border-slate-200 text-slate-500 hover:border-indigo-300 hover:bg-indigo-50 hover:text-indigo-600 transition-all bg-white/50">
                                            # {{ tag }}
                                        </button>
                                    </div>
                                </div>
                             </div>

                             <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2 block pl-1">Notes</label>
                                <div v-if="isEditing && !modals.history"><textarea v-model="currentItem.note" class="w-full h-24 p-4 bg-white/50 border border-slate-200 rounded-2xl text-sm outline-none focus:border-indigo-400 focus:bg-white transition-all resize-none placeholder-slate-300 shadow-sm" placeholder="添加备注..."></textarea></div>
                                <div v-else class="text-sm text-slate-500 bg-slate-50/50 p-4 rounded-2xl border border-slate-100 italic min-h-[60px]">{{ displayItem.note || "无备注" }}</div>
                             </div>
                        </div>
                     </template>
                </div>
            </div>
        </div>
    </transition>
    
    <transition name="fade">
        <div v-if="modals.upload" class="fixed inset-0 z-[70] flex items-center justify-center bg-slate-900/20 backdrop-blur-sm" @click.self="modals.upload = false">
            <div class="glass-panel rounded-3xl shadow-2xl p-6 w-80 animate-scale-in border border-white/60">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-slate-800 text-lg">添加媒体</h3>
                    <button @click="modals.upload = false" class="w-8 h-8 rounded-full hover:bg-slate-100 flex items-center justify-center text-slate-400 hover:text-slate-600 transition-all"><i class="fas fa-times"></i></button>
                </div>
                <div class="space-y-3">
                    <button @click="triggerLocalUpload" class="w-full text-left p-4 rounded-2xl bg-white/50 hover:bg-indigo-50 border border-white hover:border-indigo-200 transition-all font-bold flex items-center gap-4 text-slate-600 group shadow-sm hover:shadow-md">
                        <div class="w-12 h-12 rounded-xl bg-white flex items-center justify-center text-indigo-500 shadow-sm group-hover:scale-110 transition-transform"><i class="fas fa-folder-open text-lg"></i></div>
                        <div>
                            <div class="text-sm text-slate-800">本地上传</div>
                            <div class="text-[10px] text-slate-400 font-normal">支持多选</div>
                        </div>
                    </button>
                    <button @click="triggerPasteInput" class="w-full text-left p-4 rounded-2xl bg-white/50 hover:bg-indigo-50 border border-white hover:border-indigo-200 transition-all font-bold flex items-center gap-4 text-slate-600 group shadow-sm hover:shadow-md">
                        <div class="w-12 h-12 rounded-xl bg-white flex items-center justify-center text-indigo-500 shadow-sm group-hover:scale-110 transition-transform"><i class="fas fa-paste text-lg"></i></div>
                        <div>
                            <div class="text-sm text-slate-800">粘贴板读取</div>
                            <div class="text-[10px] text-slate-400 font-normal">直接 Ctrl+V</div>
                        </div>
                    </button>
                    <button @click="triggerUrlInput" class="w-full text-left p-4 rounded-2xl bg-white/50 hover:bg-indigo-50 border border-white hover:border-indigo-200 transition-all font-bold flex items-center gap-4 text-slate-600 group shadow-sm hover:shadow-md">
                        <div class="w-12 h-12 rounded-xl bg-white flex items-center justify-center text-indigo-500 shadow-sm group-hover:scale-110 transition-transform"><i class="fas fa-link text-lg"></i></div>
                        <div>
                            <div class="text-sm text-slate-800">网络链接</div>
                            <div class="text-[10px] text-slate-400 font-normal">输入 URL</div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </transition>

    <transition name="fade">
        <div v-if="isPromptExpanded && isEditing" class="prompt-fullscreen">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-black text-2xl text-slate-800 flex items-center gap-3"><i class="fas fa-edit text-indigo-500"></i> Prompt 全屏编辑</h3>
                <button @click="isPromptExpanded = false" class="bg-slate-100 hover:bg-slate-200 text-slate-600 px-6 py-3 rounded-2xl font-bold transition-colors">完成 / 收起</button>
            </div>
            <textarea v-model="currentItem.prompt" class="flex-1 w-full bg-slate-50 border border-slate-200 rounded-3xl p-10 text-xl font-mono leading-loose outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20 resize-none placeholder-slate-300 shadow-inner" placeholder="在此输入详细的提示词..."></textarea>
        </div>
    </transition>

    <transition name="fade">
        <div v-if="modals.settings" class="fixed inset-0 z-[110] flex items-center justify-center bg-slate-900/40 backdrop-blur-md">
            <div class="glass-heavy rounded-3xl w-[800px] h-[600px] shadow-2xl flex overflow-hidden ring-1 ring-white/50 relative">
                <div class="w-64 border-r border-slate-200/60 bg-white/60 flex flex-col py-6 space-y-1 backdrop-blur-md">
                     <div class="px-6 mb-6">
                        <h2 class="font-black text-xl text-slate-800 tracking-tight">Settings</h2>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1">Configuration</p>
                     </div>
                     <button @click="settingsTab='privacy'" class="w-full text-left px-6 py-3 text-sm font-bold transition-all flex items-center gap-3 relative overflow-hidden group" :class="settingsTab==='privacy'?'text-indigo-600 bg-indigo-50/50':'text-slate-500 hover:bg-slate-100/50'">
                        <div class="w-1 h-full absolute left-0 top-0 bg-indigo-500 transition-all duration-300" :class="settingsTab==='privacy'?'opacity-100':'opacity-0'"></div>
                        <i class="fas fa-user-shield w-5 text-center"></i> 隐私安全
                     </button>
                     <button @click="settingsTab='data'" class="w-full text-left px-6 py-3 text-sm font-bold transition-all flex items-center gap-3 relative overflow-hidden group" :class="settingsTab==='data'?'text-indigo-600 bg-indigo-50/50':'text-slate-500 hover:bg-slate-100/50'">
                        <div class="w-1 h-full absolute left-0 top-0 bg-indigo-500 transition-all duration-300" :class="settingsTab==='data'?'opacity-100':'opacity-0'"></div>
                        <i class="fas fa-database w-5 text-center"></i> 数据管理
                     </button>
                </div>
                
                <div class="flex-1 flex flex-col bg-white/40 relative">
                    <div class="flex-1 overflow-y-auto p-8 custom-scrollbar pb-24">
                        <div v-if="settingsTab==='privacy'" class="space-y-8 animate-fade-in-up">
                            <div class="bg-white/60 p-5 rounded-2xl border border-slate-200/60 shadow-sm flex justify-between items-center">
                                <div>
                                    <h3 class="font-bold text-slate-800 text-lg">隐私模式开关</h3>
                                    <p class="text-xs text-slate-500 mt-1">开启后，带有特定标签的内容将需要密码访问。</p>
                                </div>
                                <div class="relative inline-block w-14 h-8 rounded-full cursor-pointer transition-colors duration-300" :class="tempConfig.enabled ? 'bg-indigo-500' : 'bg-slate-200'" @click="tempConfig.enabled = !tempConfig.enabled">
                                    <span class="absolute top-1 left-1 bg-white w-6 h-6 rounded-full shadow-md transition-transform duration-300" :class="tempConfig.enabled ? 'translate-x-6' : ''"></span>
                                </div>
                            </div>
                            
                            <div v-if="tempConfig.enabled" class="space-y-6">
                                <div>
                                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2 tracking-wider">访问密码 Password</label>
                                    <input type="text" v-model="tempConfig.password" class="w-full bg-white/50 border border-slate-200 p-3 rounded-xl text-base font-mono focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 outline-none transition-all shadow-sm tracking-widest text-center" placeholder="设置密码">
                                </div>
                                
                                <div>
                                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2 tracking-wider">隐藏方式 Mode</label>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div @click="tempConfig.hideMode = 'hidden'" :class="tempConfig.hideMode === 'hidden' ? 'border-indigo-500 bg-indigo-50 ring-1 ring-indigo-200' : 'border-slate-200 hover:border-slate-300 bg-white/50'" class="border rounded-xl p-4 cursor-pointer transition-all hover:shadow-md flex flex-col items-center justify-center gap-2 text-center h-28">
                                            <i class="fas fa-eye-slash text-2xl" :class="tempConfig.hideMode === 'hidden' ? 'text-indigo-500' : 'text-slate-300'"></i>
                                            <div>
                                                <div class="font-bold text-sm text-slate-700">完全隐藏</div>
                                                <p class="text-[10px] text-slate-400 mt-1">列表不显示，不占位</p>
                                            </div>
                                        </div>
                                        <div @click="tempConfig.hideMode = 'blur'" :class="tempConfig.hideMode === 'blur' ? 'border-indigo-500 bg-indigo-50 ring-1 ring-indigo-200' : 'border-slate-200 hover:border-slate-300 bg-white/50'" class="border rounded-xl p-4 cursor-pointer transition-all hover:shadow-md flex flex-col items-center justify-center gap-2 text-center h-28">
                                            <i class="fas fa-low-vision text-2xl" :class="tempConfig.hideMode === 'blur' ? 'text-indigo-500' : 'text-slate-300'"></i>
                                            <div>
                                                <div class="font-bold text-sm text-slate-700">模糊遮罩</div>
                                                <p class="text-[10px] text-slate-400 mt-1">显示卡片但内容打码</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2 tracking-wider">隐私标签 Hidden Tags</label>
                                    <div class="flex gap-2 mb-3">
                                        <input v-model="newHiddenTag" @keyup.enter="addHiddenTag" placeholder="输入标签名并回车..." class="flex-1 bg-white/50 border border-slate-200 rounded-xl px-4 py-2 text-sm focus:border-indigo-500 focus:outline-none transition-all">
                                        <button @click="addHiddenTag" class="bg-slate-800 text-white px-4 py-2 rounded-xl text-sm font-bold hover:bg-slate-700 shadow-lg active:scale-95 transition-all"><i class="fas fa-plus"></i></button>
                                    </div>
                                    <div class="flex flex-wrap gap-2 p-3 bg-white/30 rounded-xl border border-slate-200/50 min-h-[60px]">
                                        <span v-for="tag in tempConfig.hiddenTags" :key="tag" class="inline-flex items-center px-3 py-1 rounded-lg text-xs font-bold bg-indigo-100 text-indigo-700 border border-indigo-200 shadow-sm">{{ tag }}<button @click="removeHiddenTag(tag)" class="ml-2 hover:text-red-500"><i class="fas fa-times"></i></button></span>
                                        <span v-if="!tempConfig.hiddenTags.length" class="text-xs text-slate-400 w-full text-center py-2">暂无隐私标签</span>
                                    </div>
                                    
                                     <div class="mt-3" v-if="allTags.length > 0">
                                        <div class="text-[10px] font-bold text-slate-400 mb-2">点击添加现有标签：</div>
                                        <div class="flex flex-wrap gap-2 max-h-32 overflow-y-auto custom-scrollbar p-1">
                                            <button v-for="tag in allTags" :key="tag" v-show="!tempConfig.hiddenTags.includes(tag)" @click="addHiddenTagFromList(tag)" class="px-2 py-1 rounded-lg text-[10px] font-bold bg-white border border-slate-200 text-slate-500 hover:border-indigo-300 hover:text-indigo-600 hover:bg-indigo-50 transition-all dashed-border"> + {{ tag }} </button>
                                            <span v-if="allTags.every(t => tempConfig.hiddenTags.includes(t))" class="text-[10px] text-slate-300 italic">所有标签已加入</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div v-if="settingsTab==='data'" class="space-y-8 animate-fade-in-up">
                             <div class="bg-white/60 p-6 rounded-2xl border border-slate-200/60 shadow-sm">
                                <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="fas fa-history text-indigo-500"></i> 版本控制</h3>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-3 tracking-wider">历史记录保留数量 (Max History)</label>
                                <div class="flex items-center gap-4">
                                    <input type="range" v-model.number="tempConfig.maxHistory" min="1" max="20" class="flex-1 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600">
                                    <div class="w-12 text-center font-bold text-indigo-600 bg-indigo-50 border border-indigo-100 rounded-lg py-1">{{ tempConfig.maxHistory }}</div>
                                </div>
                                <p class="text-[10px] text-slate-400 mt-2">当修改次数超过此限制时，最旧的版本将被自动清除以节省空间。</p>
                             </div>

                             <div class="bg-white/60 p-6 rounded-2xl border border-slate-200/60 shadow-sm">
                                <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2"><i class="fas fa-file-export text-indigo-500"></i> 备份与迁移</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <button @click="exportData" class="flex flex-col items-center justify-center gap-2 py-6 bg-white border border-slate-200 hover:border-indigo-300 hover:bg-indigo-50 text-slate-600 hover:text-indigo-600 rounded-xl font-bold transition-all shadow-sm hover:shadow-md group">
                                        <i class="fas fa-file-export text-2xl group-hover:scale-110 transition-transform"></i>
                                        <span>导出数据 (JSON)</span>
                                    </button>
                                    <button @click="triggerImport" class="flex flex-col items-center justify-center gap-2 py-6 bg-white border border-slate-200 hover:border-indigo-300 hover:bg-indigo-50 text-slate-600 hover:text-indigo-600 rounded-xl font-bold transition-all shadow-sm hover:shadow-md group">
                                        <i class="fas fa-file-import text-2xl group-hover:scale-110 transition-transform"></i>
                                        <span>导入数据</span>
                                    </button>
                                </div>
                             </div>
                        </div>
                    </div>

                    <div class="absolute bottom-0 left-0 right-0 p-6 border-t border-slate-100/50 bg-white/80 backdrop-blur-md grid grid-cols-2 gap-4 z-10">
                        <button @click="closeSettings(false)" class="py-3 text-slate-500 bg-slate-100 hover:bg-slate-200 rounded-xl text-sm font-bold transition-all flex items-center justify-center gap-2">
                            <i class="fas fa-times"></i> 取消
                        </button>
                        <button @click="closeSettings(true)" class="bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl text-sm font-bold shadow-lg shadow-indigo-200 hover:shadow-xl active:scale-95 transition-all flex items-center justify-center gap-2">
                            <i class="fas fa-check"></i> 保存更改
                        </button>
                    </div>
                </div>
                
                <button @click="closeSettings(false)" class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 hover:bg-slate-200 text-slate-400 hover:text-slate-600 transition-all z-20"><i class="fas fa-times"></i></button>
            </div>
        </div>
    </transition>

    <transition name="fade"><div v-if="modals.password" class="fixed inset-0 z-[120] flex items-center justify-center bg-slate-900/30 backdrop-blur-md"><div class="glass-panel p-10 rounded-[2.5rem] w-96 text-center animate-scale-in border border-white/60 shadow-2xl"><div class="w-24 h-24 bg-gradient-to-br from-indigo-100 to-violet-100 text-indigo-600 rounded-[2rem] flex items-center justify-center mx-auto mb-8 text-4xl shadow-inner"><i class="fas fa-fingerprint"></i></div><h3 class="font-black text-2xl text-slate-800 mb-2">隐私验证</h3><p class="text-sm text-slate-500 mb-8 font-medium">Please enter password to unlock</p><input type="password" v-model="inputPassword" class="w-full border-2 border-slate-200 p-4 rounded-2xl mb-8 text-center text-3xl tracking-[0.5em] focus:border-indigo-500 focus:outline-none transition-colors bg-white/60 font-bold" placeholder="••••"><div class="flex gap-4"><button @click="modals.password=false" class="flex-1 py-4 text-slate-500 bg-slate-100 hover:bg-slate-200 rounded-2xl font-bold transition-colors">取消</button><button @click="unlockPrivacy" class="flex-1 py-4 bg-gradient-to-r from-indigo-600 to-violet-600 text-white rounded-2xl font-bold shadow-lg hover:shadow-xl transition-all">解锁</button></div></div></div></transition>

</div>

<script>
    const { createApp, ref, computed, onMounted, watch } = Vue;

    createApp({
        setup() {
            // UI 状态变量
            const viewMode = ref('waterfall');
            const sliderVal = ref(5);
            const searchQuery = ref('');
            const isSidebarOpen = ref(true); 
            const sidebarWidth = ref(320); 
            const isResizing = ref(false);
            const isSortMenuOpen = ref(false); 
            const modals = ref({ settings: false, detail: false, password: false, history: false, upload: false });
            const inputPassword = ref('');
            const currentItem = ref({}); 
            const isEditing = ref(false); 
            const isCreating = ref(false); 
            const activeMediaIndex = ref(0); 
            const settingsTab = ref('privacy');
            
            // 隐私设置 (本地缓存即可，无需存后端)
            const privacy = ref({ isUnlocked: false, config: { enabled: false, password: '123', hideMode: 'hidden', hiddenTags: ['R18', 'Private'], maxHistory: 5 } });
            const tempConfig = ref({});
            
            const newHiddenTag = ref(''); 
            const newToolInput = ref('');
            const newModelInput = ref('');
            const sortConfig = ref({ key: 'updatedTime', order: 'desc' });
            const isPromptExpanded = ref(false);
            const editingCategory = ref('图片');
            const fileInput = ref(null);
            const importInput = ref(null);
            const selectedHistoryLog = ref(null);
            const videoRefs = ref({});
            const prompts = ref([]);
            const showFavoritesOnly = ref(false);
            const toasts = ref([]);

            // ================== 核心：与后端通讯的新逻辑 ==================

            // 1. 加载数据
            const loadData = async () => {
                try {
                    const res = await fetch('/api/prompts');
                    if (!res.ok) throw new Error('网络请求失败');
                    const data = await res.json();
                    
                    prompts.value = data.map(item => ({
                        ...item, 
                        tags: item.tags || [], 
                        tools: item.tools || [], 
                        models: item.models || [],
                        categories: item.categories || (item.category ? [item.category] : ['t2i']),
                        mediaList: item.mediaList || [], 
                        history: item.history || [], 
                        isFavorite: !!item.isFavorite,
                        isPlaying: false, 
                        showPlayBtn: false
                    }));
                } catch (e) {
                    console.error("加载失败", e);
                    showToast("无法连接服务器", "error");
                }
            };

            // 2. 保存数据 (新增或更新)
            const saveItem = async () => {
                const now = Date.now();
                currentItem.value.updatedTime = now;
                
                let catCode = 't2i'; 
                if (editingCategory.value === '文字') catCode = 't2t'; 
                if (editingCategory.value === '视频') catCode = 't2v'; 
                currentItem.value.category = catCode; 
                currentItem.value.categories = [catCode]; 
                
                currentItem.value.tool = (currentItem.value.tools && currentItem.value.tools[0]) || ''; 
                currentItem.value.model = (currentItem.value.models && currentItem.value.models[0]) || ''; 
                
                if (!Array.isArray(currentItem.value.history)) currentItem.value.history = []; 
                currentItem.value.history.push({ 
                    time: now, 
                    action: isCreating ? '创建项目' : '更新属性', 
                    user: 'User', 
                    snapshot: JSON.parse(JSON.stringify(currentItem.value)) 
                }); 
                
                const limit = privacy.value.config.maxHistory || 5; 
                if (currentItem.value.history.length > limit) { 
                    currentItem.value.history = currentItem.value.history.slice(-limit); 
                }

                try {
                    const res = await fetch('/api/prompts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(currentItem.value)
                    });
                    const result = await res.json();
                    
                    if (result.status === 'created' || result.status === 'updated') {
                        showToast("保存成功", "success");
                        isEditing.value = false; 
                        isCreating.value = false;
                        loadData(); // 重新加载以获取最新排序和ID
                    }
                } catch (e) {
                    showToast("保存失败: " + e.message, "error");
                }
            };

            // 3. 删除数据
            const deleteItem = async (item = null) => { 
                if (!confirm("确定删除吗？")) return; 
                const targetId = item ? item.id : currentItem.value.id; 
                
                try {
                    await fetch(`/api/prompts/${targetId}`, { method: 'DELETE' });
                    showToast("删除成功");
                    modals.value.detail = false; 
                    loadData();
                } catch (e) {
                    showToast("删除失败", "error");
                }
            };

            // 4. 文件上传 (改用 FormData 上传)
            const processFile = async (file) => {
                if (file.size > 100 * 1024 * 1024) { 
                    showToast(`文件太大了`, "error"); 
                    return; 
                }
                
                const formData = new FormData();
                formData.append('file', file);
                
                showToast("正在上传...", "info");
                try {
                    const res = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();
                    
                    if (!currentItem.value.mediaList) currentItem.value.mediaList = [];
                    // 后端返回 { url: '/uploads/xxx.jpg', thumbnail: '...' }
                    currentItem.value.mediaList.push(data.url);
                    showToast("上传成功", "success");
                } catch (e) {
                    showToast("上传失败", "error");
                    console.error(e);
                }
            };

            // ================== 辅助逻辑 ==================

            const showToast = (message, type = 'info') => {
                const id = Date.now();
                toasts.value.push({ id, message, type });
                setTimeout(() => { toasts.value = toasts.value.filter(t => t.id !== id); }, 3000);
            };
            const getToastIcon = (type) => {
                if (type === 'success') return 'fas fa-check-circle text-emerald-500';
                if (type === 'error') return 'fas fa-exclamation-circle text-rose-500';
                return 'fas fa-info-circle text-indigo-500';
            };

            const startResize = () => { isResizing.value = true; window.addEventListener('mousemove', handleResize); window.addEventListener('mouseup', stopResize); };
            const stopResize = () => { isResizing.value = false; localStorage.setItem('sidebarWidth', sidebarWidth.value); window.removeEventListener('mousemove', handleResize); window.removeEventListener('mouseup', stopResize); };
            const handleResize = (e) => { if (isResizing.value) { let newWidth = e.clientX; if (newWidth < 240) newWidth = 240; if (newWidth > 500) newWidth = 500; sidebarWidth.value = newWidth; } };

            const sortOptions = [{ label: '按修改时间', value: 'updatedTime' }, { label: '按创建时间', value: 'createdTime' }, { label: '按名称排序', value: 'title' }];
            const getSortLabel = (key) => sortOptions.find(o => o.value === key)?.label || '排序';
            const selectSort = (key) => { sortConfig.value.key = key; isSortMenuOpen.value = false; };
            const allTags = computed(() => [...new Set(prompts.value.flatMap(p => p.tags || []))]);
            const allTools = computed(() => [...new Set(prompts.value.flatMap(p => p.tools || []))]);
            const allModels = computed(() => [...new Set(prompts.value.flatMap(p => p.models || []))]);
            const filters = ref({ mediaType: { label: 'Category 分类', options: ['文字', '图片', '视频'], selected: [] } });
            const dynamicFilters = computed(() => ({ tags: { label: '标签', options: allTags.value, selected: [] }, tools: { label: '工具', options: allTools.value, selected: [] }, models: { label: '模型', options: allModels.value, selected: [] } }));
            const filterState = ref({ tags: [], tools: [], models: [] });
            const resetAllFilters = () => { filters.value.mediaType.selected = []; filterState.value.tags = []; filterState.value.tools = []; filterState.value.models = []; };

            const filteredList = computed(() => {
                let list = prompts.value.filter(item => {
                    const itemTags = item.tags || [];
                    if (showFavoritesOnly.value && !item.isFavorite) return false;
                    const hasHiddenTag = itemTags.some(t => privacy.value.config.hiddenTags.includes(t));
                    if (privacy.value.config.enabled && !privacy.value.isUnlocked && hasHiddenTag) { if (privacy.value.config.hideMode === 'hidden') return false; }
                    if (searchQuery.value && !item.title.toLowerCase().includes(searchQuery.value.toLowerCase())) return false;
                    if (filters.value.mediaType.selected.length) {
                        const cats = item.categories || [item.category];
                        const wantsText = filters.value.mediaType.selected.includes('文字'); const wantsImg = filters.value.mediaType.selected.includes('图片'); const wantsVideo = filters.value.mediaType.selected.includes('视频');
                        let match = false;
                        if (wantsText && cats.includes('t2t')) match = true; if (wantsImg && (cats.includes('t2i') || cats.includes('i2i'))) match = true; if (wantsVideo && (cats.includes('t2v'))) match = true;
                        if (!match) return false;
                    }
                    if (filterState.value.tags.length > 0) { if (!filterState.value.tags.every(tag => itemTags.includes(tag))) return false; }
                    if (filterState.value.tools.length > 0) { if (!filterState.value.tools.every(tool => (item.tools||[]).includes(tool))) return false; }
                    if (filterState.value.models.length > 0) { if (!filterState.value.models.every(model => (item.models||[]).includes(model))) return false; }
                    return true;
                });
                list.sort((a, b) => { let valA = a[sortConfig.value.key]; let valB = b[sortConfig.value.key]; if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); } if (valA < valB) return sortConfig.value.order === 'asc' ? -1 : 1; if (valA > valB) return sortConfig.value.order === 'asc' ? 1 : -1; return 0; });
                return list;
            });

            const toggleSortOrder = () => { sortConfig.value.order = sortConfig.value.order === 'asc' ? 'desc' : 'asc'; };
            const createNew = () => { const now = Date.now(); currentItem.value = { id: now, createdTime: now, updatedTime: now, title: '新创意', category: 't2i', categories: ['t2i'], mediaList: [], tags: [], prompt: '', tools: [], models: [], resultText: '', history: [], note: '', isFavorite: false }; editingCategory.value = '图片'; isEditing.value = true; isCreating.value = true; activeMediaIndex.value = 0; modals.value.detail = true; };
            const getCategoryLabel = (item) => { const cats = item.categories || []; if (cats.includes('t2t')) return 'TEXT'; if (cats.includes('t2v')) return 'VIDEO'; return 'IMAGE'; };
            const openDetail = (item) => { if(shouldBlur(item) || (privacy.value.config.enabled && !privacy.value.isUnlocked && isItemPrivate(item))) { handleEyeClick(); return; } const clone = JSON.parse(JSON.stringify(item)); if (!clone.categories) clone.categories = [clone.category || 't2i']; if (!clone.tools) clone.tools = []; if (!clone.models) clone.models = []; if (!clone.tags) clone.tags = []; if (!clone.mediaList) clone.mediaList = []; currentItem.value = clone; if (clone.categories.includes('t2t')) editingCategory.value = '文字'; else if (clone.categories.includes('t2v')) editingCategory.value = '视频'; else editingCategory.value = '图片'; activeMediaIndex.value = 0; isEditing.value = false; isCreating.value = false; modals.value.detail = true; modals.value.history = false; };
            const quickEdit = (item) => { openDetail(item); isEditing.value = true; };
            const startEdit = () => { isEditing.value = true; };
            const cancelEdit = () => { if (isCreating) { modals.value.detail = false; } else { openDetail(prompts.value.find(p => p.id === currentItem.value.id)); isEditing.value = false; } };
            const viewHistoryItem = (log) => { selectedHistoryLog.value = log; activeMediaIndex.value = 0; }
            const restoreVersion = (log) => { if(!confirm("确定要恢复到此版本吗？这将覆盖当前内容。")) return; const snapshot = log.snapshot; currentItem.value = JSON.parse(JSON.stringify(snapshot)); currentItem.value.history = JSON.parse(JSON.stringify(prompts.value.find(p => p.id === currentItem.value.id)?.history || [])); saveItem(); showToast("已恢复到版本", "success"); modals.value.history = false; modals.value.detail = true; isEditing.value = false; };
            
            const triggerLocalUpload = () => { if (fileInput.value) fileInput.value.click(); modals.value.upload = false; };
            const triggerUrlInput = () => { modals.value.upload = false; mockUpload(); };
            const triggerPasteInput = () => { modals.value.upload = false; showToast("请直接按 Ctrl+V 粘贴", "info"); };
            const mockUpload = () => { const url = prompt("请输入图片/视频 URL:", ""); if(url) { if(!currentItem.value.mediaList) currentItem.value.mediaList = []; currentItem.value.mediaList.push(url); showToast("链接添加成功", "success"); } };
            const handleFileUpload = (e) => { const files = e.target.files; if (!files.length) return; for (let i = 0; i < files.length; i++) { processFile(files[i]); } e.target.value = ''; };
            const handlePaste = (event) => { if (!isEditing.value || !modals.value.detail || editingCategory.value === '文字') return; const items = (event.clipboardData || event.originalEvent.clipboardData).items; for (let index in items) { const item = items[index]; if (item.kind === 'file') { const blob = item.getAsFile(); processFile(blob); } } };
            
            const exportData = () => { const dataStr = JSON.stringify(prompts.value, null, 2); const blob = new Blob([dataStr], { type: "application/json" }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `backup.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); };
            const triggerImport = () => { if(importInput.value) importInput.value.click(); };
            const handleImportData = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const data = JSON.parse(e.target.result); if (Array.isArray(data)) { if(confirm("导入?")) { prompts.value = data; showToast("数据已读入内存(需手动编辑保存)", "info"); modals.value.settings = false; } } } catch (err) { } }; reader.readAsText(file); e.target.value = ''; };
            
            const setVideoRef = (el, id) => { if(el) videoRefs.value[id] = el; };
            const playVideo = (item) => { item.isPlaying = true; const el = videoRefs.value[item.id]; if (el) { el.muted = false; el.play().catch(e => console.error(e)); } };
            const stopVideo = (item) => { if (item.isPlaying) { item.isPlaying = false; const el = videoRefs.value[item.id]; if (el) { el.pause(); el.currentTime = 0; el.muted = true; } } item.showPlayBtn = false; };
            const nextCardImage = (item) => { if (!item.mediaList || item.mediaList.length <= 1) return; if (item.activeImgIdx === undefined) item.activeImgIdx = 0; item.activeImgIdx = (item.activeImgIdx + 1) % item.mediaList.length; };
            const prevCardImage = (item) => { if (!item.mediaList || item.mediaList.length <= 1) return; if (item.activeImgIdx === undefined) item.activeImgIdx = 0; item.activeImgIdx = (item.activeImgIdx - 1 + item.mediaList.length) % item.mediaList.length; };
            const nextMedia = () => { if (activeMediaIndex.value < currentItem.value.mediaList.length - 1) activeMediaIndex.value++; else activeMediaIndex.value = 0; };
            const prevMedia = () => { if (activeMediaIndex.value > 0) activeMediaIndex.value--; else activeMediaIndex.value = currentItem.value.mediaList.length - 1; };
            const shouldBlur = (item) => !privacy.value.config.enabled || privacy.value.isUnlocked ? false : ((item.tags||[]).some(t => privacy.value.config.hiddenTags.includes(t)) && privacy.value.config.hideMode === 'blur');
            const isItemPrivate = (item) => (item.tags||[]).some(t => privacy.value.config.hiddenTags.includes(t));
            const eyeButtonText = computed(() => !privacy.value.config.enabled ? '未启用' : (privacy.value.isUnlocked ? '隐私可见' : '已隐藏'));
            const eyeIconClass = computed(() => !privacy.value.config.enabled ? 'fa-eye-slash text-slate-400' : (privacy.value.isUnlocked ? 'fa-lock-open text-emerald-500' : 'fa-lock text-rose-500'));
            const eyeButtonClass = computed(() => !privacy.value.config.enabled ? 'bg-white border-slate-200 text-slate-400' : (privacy.value.isUnlocked ? 'bg-emerald-50 border-emerald-100 text-emerald-700 ring-1 ring-emerald-200 hover:bg-emerald-100' : 'bg-rose-50 border-rose-100 text-rose-700 ring-1 ring-rose-200 hover:bg-rose-100'));
            const eyeButtonTitle = computed(() => !privacy.value.config.enabled ? '去设置开启' : (privacy.value.isUnlocked ? '点击锁定' : '点击解锁'));
            const handleEyeClick = () => { if (!privacy.value.config.enabled) { openSettings(); settingsTab.value='privacy'; } else if (privacy.value.isUnlocked) { privacy.value.isUnlocked = false; showToast("隐私内容已锁定"); } else { inputPassword.value = ''; modals.value.password = true; } };
            const unlockPrivacy = () => { if (inputPassword.value === privacy.value.config.password) { privacy.value.isUnlocked = true; modals.value.password = false; showToast("解锁成功", "success"); } else { showToast("密码错误", "error"); } };
            const openSettings = () => { tempConfig.value = JSON.parse(JSON.stringify(privacy.value.config)); newHiddenTag.value = ''; modals.value.settings = true; };
            const closeSettings = (save) => { if (save) { privacy.value.config = JSON.parse(JSON.stringify(tempConfig.value)); if (!privacy.value.config.enabled) privacy.value.isUnlocked = false; showToast("设置已保存", "success"); } modals.value.settings = false; };
            const formatDate = (ts) => new Date(ts).toLocaleString();
            const toggleFilter = (key, val) => { if (key === 'mediaType') { const s = filters.value.mediaType.selected; s.includes(val) ? s.splice(s.indexOf(val),1) : s.push(val); } else { const s = filterState.value[key]; s.includes(val) ? s.splice(s.indexOf(val),1) : s.push(val); } };
            const addHiddenTag = () => { if (newHiddenTag.value && !tempConfig.value.hiddenTags.includes(newHiddenTag.value)) { tempConfig.value.hiddenTags.push(newHiddenTag.value); newHiddenTag.value = ''; } };
            const addHiddenTagFromList = (tag) => { if (!tempConfig.value.hiddenTags.includes(tag)) { tempConfig.value.hiddenTags.push(tag); } };
            const removeHiddenTag = (tag) => { const idx = tempConfig.value.hiddenTags.indexOf(tag); if (idx > -1) tempConfig.value.hiddenTags.splice(idx, 1); };
            const getTagStyle = (tag) => { const colors = [ 'bg-blue-50 text-blue-600 border-blue-100', 'bg-purple-50 text-purple-600 border-purple-100', 'bg-emerald-50 text-emerald-600 border-emerald-100', 'bg-rose-50 text-rose-600 border-rose-100', 'bg-amber-50 text-amber-600 border-amber-100', 'bg-cyan-50 text-cyan-600 border-cyan-100' ]; let hash = 0; for (let i = 0; i < tag.length; i++) hash = tag.charCodeAt(i) + ((hash << 5) - hash); const index = Math.abs(hash) % colors.length; return colors[index] + ' border'; };
            const isTextCard = (item) => item.category === 't2t' || (item.categories && item.categories.includes('t2t'));
            const isVideo = (url) => { if (!url) return false; if (url.startsWith('data:video')) return true; const ext = url.split('.').pop().toLowerCase(); return ['mp4', 'webm', 'ogg', 'mov'].includes(ext); };
            const toggleItemCategory = (cat) => { };
            const addRecTool = (val) => { if(!currentItem.value.tools) currentItem.value.tools = []; if (val && !currentItem.value.tools.includes(val)) { currentItem.value.tools.push(val); newToolInput.value = ''; } };
            const addItemTool = () => addRecTool(newToolInput.value);
            const addRecModel = (val) => { if(!currentItem.value.models) currentItem.value.models = []; if (val && !currentItem.value.models.includes(val)) { currentItem.value.models.push(val); newModelInput.value = ''; } };
            const addItemModel = () => addRecModel(newModelInput.value);
            const copyText = (text) => {
                if (!text) return;
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text).then(() => showToast('已复制', 'success')).catch(err => fallbackCopy(text));
                } else { fallbackCopy(text); }
            };
            const fallbackCopy = (text) => {
                const textArea = document.createElement("textarea"); textArea.value = text; textArea.style.position = "fixed"; document.body.appendChild(textArea); textArea.focus(); textArea.select();
                try { document.execCommand('copy'); showToast('已复制', 'success'); } catch (err) { showToast('无法复制', 'error'); }
                document.body.removeChild(textArea);
            };
            const addRecTag = (tag) => { if(!currentItem.value.tags) currentItem.value.tags = []; if (!currentItem.value.tags.includes(tag)) { currentItem.value.tags.push(tag); } }
            const duplicatePrompt = (item) => { const newItem = JSON.parse(JSON.stringify(item)); newItem.id = null; newItem.title = newItem.title + ' (副本)'; currentItem.value = newItem; saveItem(); };
            const removeCurrentMedia = () => { if (currentItem.value.mediaList && currentItem.value.mediaList.length > 0) { currentItem.value.mediaList.splice(activeMediaIndex.value, 1); if (activeMediaIndex.value >= currentItem.value.mediaList.length) { activeMediaIndex.value = Math.max(0, currentItem.value.mediaList.length - 1); } } }
            const switchViewMode = (mode) => { viewMode.value = mode; sliderVal.value = mode === 'card' ? 2 : 5; };
            const handleCardClick = (item) => { if(shouldBlur(item)) { handleEyeClick(); } else { openDetail(item); } };
            const toggleFavorite = async (item) => { 
                item.isFavorite = !item.isFavorite; 
                try {
                     await fetch('/api/prompts', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(item) });
                     showToast(item.isFavorite ? '已收藏' : '已取消收藏', 'success');
                } catch(e) { console.error(e); }
            };
            const toggleFavoritesFilter = () => { showFavoritesOnly.value = !showFavoritesOnly.value; showToast(showFavoritesOnly.value ? '只显示收藏内容' : '显示全部内容'); };

            watch(() => privacy.value.config, (newVal) => { localStorage.setItem('prompt-hub-privacy', JSON.stringify(newVal)); }, { deep: true });

            onMounted(() => {
                loadData(); // 启动时加载后端数据
                const savedWidth = localStorage.getItem('sidebarWidth');
                if (savedWidth) sidebarWidth.value = parseInt(savedWidth);
                const savedPrivacy = localStorage.getItem('prompt-hub-privacy');
                if(savedPrivacy) privacy.value.config = JSON.parse(savedPrivacy);
                window.addEventListener('paste', handlePaste);
            });

            return {
                viewMode, sliderVal, searchQuery, isSidebarOpen, modals, inputPassword, currentItem, isEditing, isCreating, activeMediaIndex,
                filters, dynamicFilters, filterState, privacy, tempConfig, filteredList, sortConfig, newHiddenTag, settingsTab,
                allTools, allModels, allTags, sidebarWidth, isResizing, isSortMenuOpen, sortOptions, getSortLabel, selectSort, isPromptExpanded, editingCategory, fileInput, importInput, toasts, selectedHistoryLog,
                shouldBlur, isItemPrivate, eyeButtonText, eyeIconClass, eyeButtonClass, eyeButtonTitle, getCategoryLabel, getToastIcon,
                handleEyeClick, unlockPrivacy, openSettings, closeSettings, addHiddenTag, removeHiddenTag, resetAllFilters,
                createNew, openDetail, startEdit, cancelEdit, saveItem, deleteItem, mockUpload, toggleSortOrder, formatDate, toggleFilter, nextMedia, prevMedia, restoreVersion, viewHistoryItem,
                startResize, stopResize, handleResize, nextCardImage, prevCardImage, getTagStyle, copyText, duplicatePrompt,
                isTextCard, isVideo, toggleItemCategory, addItemTool, addItemModel, newToolInput, newModelInput, handleFileUpload, addRecTool, addRecModel, addRecTag, removeCurrentMedia,
                triggerLocalUpload, triggerUrlInput, triggerPasteInput, showToast, exportData, triggerImport, handleImportData,
                setVideoRef, playVideo, stopVideo, quickEdit, switchViewMode, handleCardClick, toggleFavorite, toggleFavoritesFilter, showFavoritesOnly,
                addHiddenTagFromList
            };
        }
    }).mount('#app');
</script>
</body>
</html>